<div class="detail-session-container">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-3xl font-bold">Détail de la Session #{{ sessionId }}</h1>
        <p-button 
            label="Retour" 
            icon="pi pi-arrow-left"
            [outlined]="true"
            routerLink="/suivi-agents/dashboard">
        </p-button>
    </div>

    <div *ngIf="loading" class="flex justify-center p-8">
        <p-progressSpinner></p-progressSpinner>
    </div>

    <div *ngIf="session && !loading">
        <!-- Informations générales -->
        <p-card class="mb-4">
            <ng-template pTemplate="header">
                <div class="p-4">
                    <h2 class="text-xl font-semibold">Informations Générales</h2>
                </div>
            </ng-template>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Agent</label>
                    <p class="text-lg">{{ getNomUtilisateur() }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Durée</label>
                    <p class="text-lg">{{ formaterDuree() }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Heure de début</label>
                    <p class="text-lg">{{ formaterDate(session.heureDebut) }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Heure de fin</label>
                    <p class="text-lg">{{ session.heureFin ? formaterDate(session.heureFin) : 'En cours' }}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Position de début</label>
                    <p class="text-sm">
                        {{ session.latitudeDebut.toFixed(6) }}, {{ session.longitudeDebut.toFixed(6) }}
                    </p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Position de fin</label>
                    <p class="text-sm">
                        <span *ngIf="session.latitudeFin && session.longitudeFin">
                            {{ session.latitudeFin.toFixed(6) }}, {{ session.longitudeFin.toFixed(6) }}
                        </span>
                        <span *ngIf="!session.latitudeFin || !session.longitudeFin">-</span>
                    </p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Distance parcourue</label>
                    <p class="text-lg font-semibold text-blue-600">{{ distanceTotale.toFixed(2) }} km</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Synchronisation</label>
                    <p-badge 
                        [value]="session.synchronise ? 'Synchronisé' : 'Non synchronisé'" 
                        [severity]="session.synchronise ? 'success' : 'warn'">
                    </p-badge>
                </div>
            </div>
        </p-card>

        <!-- Changements de statut -->
        <p-card *ngIf="changementsStatut.length > 0" class="mb-4">
            <ng-template pTemplate="header">
                <div class="p-4">
                    <h2 class="text-xl font-semibold">Changements de Statut ({{ changementsStatut.length }})</h2>
                </div>
            </ng-template>
            <p-table [value]="changementsStatut" [paginator]="true" [rows]="10">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Date/Heure</th>
                        <th>Statut</th>
                        <th>Synchronisé</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-changement>
                    <tr>
                        <td>{{ formaterDate(changement.timestamp) }}</td>
                        <td>
                            <span class="font-medium">{{ changement.statut.libelle }}</span>
                            <span class="text-sm text-gray-500 ml-2">({{ changement.statut.codeStatut }})</span>
                        </td>
                        <td>
                            <p-badge 
                                [value]="changement.synchronise ? 'Oui' : 'Non'" 
                                [severity]="changement.synchronise ? 'success' : 'warn'">
                            </p-badge>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>

        <!-- Positions GPS -->
        <p-card>
            <ng-template pTemplate="header">
                <div class="flex justify-between items-center p-4">
                    <h2 class="text-xl font-semibold">Positions GPS ({{ positions.length }})</h2>
                    <p-button 
                        label="Voir sur la carte" 
                        icon="pi pi-map"
                        [routerLink]="['/suivi-agents/carte', sessionId]">
                    </p-button>
                </div>
            </ng-template>
            <p-table [value]="positions" [paginator]="true" [rows]="20">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Date/Heure</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Précision</th>
                        <th>Synchronisé</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-position>
                    <tr>
                        <td>{{ formaterDate(position.timestamp) }}</td>
                        <td>{{ position.latitude.toFixed(6) }}</td>
                        <td>{{ position.longitude.toFixed(6) }}</td>
                        <td>
                            <span *ngIf="position.precision">{{ position.precision.toFixed(2) }} m</span>
                            <span *ngIf="!position.precision">-</span>
                        </td>
                        <td>
                            <p-badge 
                                [value]="position.synchronise ? 'Oui' : 'Non'" 
                                [severity]="position.synchronise ? 'success' : 'warn'">
                            </p-badge>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </p-card>
    </div>
</div>
